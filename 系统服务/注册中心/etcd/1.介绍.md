[toc]

## 介绍

etcd 是一个分布式键值存储数据库，支持跨平台，拥有强大的社区。etcd 的 Raft 算法，提供了可靠的方式存储分布式集群涉及的数据。etcd 广泛应用在[微服务架构](https://cloud.tencent.com/product/tse?from_column=20065&from=20065)和 Kubernates 集群中，不仅可以作为服务注册与发现，还可以作为键值对存储的中间件。从业务系统 Web 到 Kubernetes 集群，都可以很方便地从 etcd 中读取、写入数据。

etcd有如下的特点：

- 简单：etcd 的安装简单，且为用户提供了 HTTP API，用户使用起来也很简单
- 存储：etcd 的基本功能，数据分层存储在文件目录中，类似于我们日常使用的文件系统
- Watch 机制：Watch 指定的键、前缀目录的更改，并对更改时间进行通知
- 安全通信：SSL 证书验证
- 高性能：etcd 单实例可以支持 2k/s 读操作，官方也有提供基准测试脚本
- 一致可靠：基于 Raft 共识算法，实现分布式系统数据的高可用性、一致性

## 本质

etcd本质是一个k:v的持久化数据库，只是某些时候，他非常适合作为注册中心，同样的redis理论上也可以用来作为注册中心

### 存储的数据类型

etcd 主要用于存储键值对数据，其中键和值都可以是字节数组类型（`[]byte`）。这意味着你可以存储任何类型的数据，只要你能够将它们序列化成字节数组。通常，开发者会将数据序列化成 JSON、Protocol Buffers 或其他格式进行存储，但等效地，你也可以存储纯字符串（通过将字符串转化为字节数组）。

总结来说，etcd 并不是只能存储字符串类型数据，只要数据能够被序列化成字节流（如 JSON、XML 或二进制数据），它就能存储。

## CAP满足

etcd满足CP

## 应用场景

etcd 在**稳定性、可靠性和可伸缩性**表现极佳，同时也为云原生应用系统提供了协调机制。etcd 经常用于服务注册与发现的场景，此外还有键值对存储、消息发布与订阅、分布式锁等场景。

## 存储结构

etcd 是一个**「键值存储」**的组件，存储是 etcd 最基本的功能，其他应用场景都是建立在 etcd 的可靠存储上。

etcd 的存储有如下特点：

- 采用键值对数据存储，读写性能一般高于[关系型数据库](https://cloud.tencent.com/product/tencentdb-catalog?from_column=20065&from=20065)；
- etcd 集群分布式存储，多节点集群更加可靠；
- etcd 的存储采用类似文件目录的结构：
  - 叶子节点存储数据，其他节点不存储，这些数据相当于文件；
  - 非叶节点一定是目录，这些节点不能存储数据。

## etcd中关键概念

### 租约

**租约** 是 etcd 中的一种机制，用于对键值对（Key-Value）设置有效期，支持定时自动删除。通过租约，etcd 允许创建有超时时间的键，这些键会在租约到期时自动失效。它们主要用于表示某些资源的生命周期，例如：

- **锁机制**：租约可以用于实现分布式锁，确保某一时刻只有一个节点持有锁。
- **服务发现**：在服务发现中，租约可以用于注册和注销服务。当服务不再需要时，它会自动删除其在 etcd 中的注册信息。
- **超时机制**：租约提供了一种在节点失败或不可用时自动清除相关资源的方法。

### watch

**Watch** 是 etcd 中的一种机制，允许客户端实时监听某些键值对的变化（如创建、更新或删除操作）。这使得等到事件发生时，客户端能够立即做出反应，而无需不断轮询等。

#### 工作原理

- 客户端通过 `watch` 请求向 etcd 注册一个监听器，指定某个键或键范围。
- 当指定的键或键范围发生变化时，etcd 会向客户端推送通知，告知发生了哪些变化（例如，某个键被修改或删除）。
- 客户端无需频繁发送请求来检查数据是否变动，降低了网络负担。

#### 使用场景

watch常再程序中使用，来监听key的事件，因为watch在命令行中使用会阻塞，他会阻塞直到事件发生。