## 前提

gozero的生成的数据库文件中，使用的数据库处理库均为go-zero自己的扩展，而并非官方库的使用。

* gozero中自带的redis不支持切换db，默认使用db 0，如果需要，用户可以在上下文中定义自己的redis组件。

## sql数据库文件生成

### sqlx和sqlc

sqlx就是正常的数据库操作，sqlc就是带缓存(可能结合了redis等缓存中间件)的的sqlx，用于减少数据库查询操作。

### 参数解释

* ddl：使用sql文件生成
* -cache：生成带缓存的sqlx model代码
* -src：使用sql文件生成时，sql文件目录
* -dir：生成目录，生成目录的最后一个目录会作为生成文件的包名
* -url：根据远程表生成时，db连接url
* -table：根据远程表生成时，远程db中对应的表
* -style：文件生成的格式，默认为gozero
  * go_zero为单次间隔下划线
  * goZero为驼峰，以此类推

### 根据远程数据库中的表生成

```
#格式
goctl model mysql datasource -url="<sql远程连接db的url>" -table="<表名>" -dir="<生成目录>" -style=<文件格式>

#例子
goctl model mysql datasource -url="root:Abc12345@tcp(192.168.15.0:4407)/image" -table="event_info" -dir="./rpc/database/sqlx/usermodel" -style=go_zero

```

### 使用sql文件生成

```
#格式
goctl model mysql ddl -src="<sql文件>" -dir="<生成目录>" -style=go_zero

#例子
goctl model mysql ddl -src="./rpc/database/sql/user/zero_users.sql" -dir="./rpc/database/sqlx/usermodel" -style=go_zero
```

## sql文件的使用

1. 配置文件中添加对应表的sqlDB连接url，和redis的配置

```yaml
...

MySQL:
  CmmUser: root:xlkjV587168@tcp(rm-wz9l233ab7366n94uoo.mysql.rds.aliyuncs.com:3306)/cmm_user?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai
  CmmSystem: root:xlkjV587168@tcp(rm-wz9l233ab7366n94uoo.mysql.rds.aliyuncs.com:3306)/cmm_system?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai
  
  
  
RedisConfig:
  Host: r-wz9zqhx6nu703mvxvrpd.redis.rds.aliyuncs.com:6379
  Type: node #node 单节点 redis
  			 #cluster redis 集群
  Pass: xlkjV587168
  Tls: false
  
...
```

2. 在对应加载的config配置中添加对应配置

```go
type Config struct {
	
	zrpc.RpcServerConf
	
	MySQL struct {
		CmmUser   string
		CmmSystem string
	}
	RedisConfig struct {
		Host string `json:",optional"`
		Type string `json:",default=node,options=node|cluster"`
		Pass string `json:",optional"`
		Tls  bool   `json:",optional"`
	}
	IM struct {
		Address string `json:",optional"`
		Port    uint32 `json:",optional"`
		Secret  string `json:",optional"`
	}
}
```

3. 在gozero项目结构的rpc模块的interval/svc目录(gozero上下文结构)的上下代码结构中，添加对应客户端，并使用config中的配置加载
   * 对于sqlc，需要传入redis的配置。

```go
type ServiceContext struct {
	Config          config.Config
	CmmUserProfile  dao.CmmUserProfile
	CmmSayhi        dao.CmmSayhiModel
	CmmSayhiBlack   dao.CmmSayhiBlackModel
	CmmUserCount    dao.CmmUserCountModel
	PgcPickupConfig dao.PgcPickupConfigModel
	RedisCli        *redis.Redis
	ImServer        *ImServerConfig
}

func NewServiceContext(c config.Config) *ServiceContext {
	mysqlConnCmmUser := sqlx.NewMysql(c.MySQL.CmmUser)
	mysqlConnCmmSystem := sqlx.NewMysql(c.MySQL.CmmSystem)
	redisCli := redis.MustNewRedis(redis.RedisConf{
		Host: c.RedisConfig.Host,
		Type: c.RedisConfig.Type,
		Pass: c.RedisConfig.Pass,
		Tls:  c.RedisConfig.Tls,
	})
	return &ServiceContext{
		Config:          c,
		CmmUserProfile:  dao.NewCmmUserProfile(mysqlConnCmmUser),
		CmmSayhi:        dao.NewCmmSayhiModel(mysqlConnCmmSystem),
		CmmSayhiBlack:   dao.NewCmmSayhiBlackModel(mysqlConnCmmSystem),
		CmmUserCount:    dao.NewCmmUserCountModel(mysqlConnCmmUser),
		PgcPickupConfig: dao.NewPgcPickupConfigModel(mysqlConnCmmSystem),
		RedisCli:        redisCli,
		ImServer: &ImServerConfig{
			Address: c.IM.Address,
			Port:    c.IM.Port,
			Secret:  c.IM.Secret,
		},
	}
}
```

