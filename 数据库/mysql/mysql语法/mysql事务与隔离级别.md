## 事务

* 事务的每一步都可以看到效果，但是只有提交后才会保存对应操作。

* mysql默认情况下自动提交

* 注意此处所指的事务相关都是基于mysql中InnoDB引擎。

* 事务是一个完整的业务逻辑单元，不可再分，具有原子性。

* 在mysql中表现为一次执行多条语句或功能，要么这些语句全部成功，要么在其中一个失败后返回到执行前的状态。

* mysql中与事务相关的语句只有DML语句。

* mysql使用事务的场景必须是多条DML语句，只有一条时使用事务没有意义。

* 事务的四大特性  

原子性：事务之下不可再细分。 

一致性：事务保证了多条DML语句同时成功或失败。  

隔离性：事务之间不会互相干扰。  

持久性：数据必须最终持久化到了硬盘中事务才算成功。  

## 事务的隔离级别
事务的隔离级别应用于事务的并发使用中，mysql事务有四个隔离级别。


* 脏读：事务之间在未提交之前可以互相读取数据，但是如果某次修改的数据被A事物读取后，修改该数据的B事物立马回滚，A事物的该次读取就是脏读。

* 不可重复读：一个事物在读取数据时，该数据会时时刻刻被其他事务改变，导致每次读取都不一样，这样即不能重复读。

* 幻读：一个事物执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的，但是如果用之前的数据处理完成后，在该事务处理的过程中数据被改变了，就相当于读取到了虚幻的数据，该现象简称幻读。

级别功能区别：

| 事务隔离级别 | 脏读 | 不可重复读 | 幻读 |
| :-- | :-- | :-- | :-- |
| 读未提交（read-uncommitted） | 是 | 是 | 是 |
| 读已提交（read-committed） | 否 | 是 | 是 |
| 可重复读（repeatable-read） | 否 | 否 | 是 |
| 串行化（serializable） | 否 | 否 | 否 |

* 读未提交（read uncommitted）：一个事务还没有提交时，它做的变更就能被别的事务看到。

* 读提交（read committed）：一个事物提交之后，它做的变更才会被其他事务看到。

* (mysql默认级别)可重复读（repeatable read）：一个事物执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。未提交变更对其他事务也是不可见的。

* 串行化（serializable）：对于同一行记录，写会加“写锁”，读会加“读锁”，当出现锁冲突时，后访问的事务需要等前一个事务执行完成，才能继续执行。


## 事务操作
### 事务的开始(自动提交的关闭)
    
    start transaction;
    
### 回滚

* 注意由于事务只对DMl语句生效，回滚的语句也只是对DML生效，对在事务中使用的create等不会回滚


    rollback;
    
* 回滚会回滚到上一次的提交点

* 回滚后会结束事务，开启自动提交。

### 提交
    
    commtl;

* 提交后会结束事务，开启自动提交。

### 使用保留点

    //存点
    savepoint <保留点名>;
    
    //回滚到保留点
    rollback to <保留点名>
    
* 回滚到保留点不会关闭事务，只有rollback才会关闭事务。


## 查看事务的隔离级别


    //全局
    select @@global.tx_isolation;
    
    //当前连接会话
    select @@session.tx_isolation;
    
## 设置隔离级别

    set session/global transaction isolation level read committed/
                                                   read uncommitted/
                                                   repeatable read/
                                                   serializable;
    
    //session表示当前会话隔离级别
    //global表示所有用户隔离级别，对应数据库服务器重启后，以配置文件中为准


* 全局的隔离级别表示该隔离级别在所有用户用默认设置默认连接该mysql服务器后默认生效的隔离级别。

* 当前会话隔离级别表示该隔离级别只是当前会话所使用的隔离级别，对于其他连接用户不生效。

    
