[toc]

## 深度测试

深度测试决定了当两个物体重合（或者彼此非常靠近类似重合）时，两个物体针对于用户视角时的遮挡关系。

当深度测试(Depth Testing)被启用的时候，OpenGL会将一个片段的深度值与深度缓冲的内容进行对比。OpenGL会执行一个深度测试，如果这个测试通过了的话，深度缓冲将会更新为新的深度值。如果深度测试失败了，片段将会被丢弃（不显示）。

* 物体中每个片段的深度值由片段的Z值经过一系列计算获得。

### 发生时机

光栅化之后、片元着色器之后，颜色写入之前，模板测试之后

## 深度缓冲

深度缓冲的目标是openGL二维窗口中每个坐标的深度值，该深度值后续会与openGL坐标中所有物体片段的深度值对比，来决定某个片段是否显示。

* 深度缓冲是由窗口系统自动创建的，它会以16、24或32位float的形式储存它的深度值。在大部分的系统中，深度缓冲的精度都是24位的。
* 深度测试被启用时，OpenGL会将一个片段的深度值与深度缓冲的内容进行对比。OpenGL会执行一个深度测试，如果测试通过，且深度缓冲开启，深度缓冲将会更新为新的深度值。如果深度测试失败，片段会被丢弃。

## 相关API

### 启用或关闭深度测试

```c
glEnable(GL_DEPTH_TEST);
glDisEnable(GL_DEPTH_TEST);
```

### 清理深度缓存

```c
glClear(GL_DEPTH_BUFFER_BIT);
```

### 深度缓存开关

只在深度测试被启用的时候才有效果。

* 关闭深度缓存后，深度缓存区域只可读。

```
glDepthMask(GL_FALSE);
glDepthMask(GL_TRUE);
```

### 深度测试函数

```c
glDepthFunc(GL_LESS);
```

这个函数接受下面表格中的比较运算符：

| 函数        | 描述                                         |
| :---------- | :------------------------------------------- |
| GL_ALWAYS   | 永远通过深度测试                             |
| GL_NEVER    | 永远不通过深度测试                           |
| GL_LESS     | 在片段深度值小于缓冲的深度值时通过测试       |
| GL_EQUAL    | 在片段深度值等于缓冲区的深度值时通过测试     |
| GL_LEQUAL   | 在片段深度值小于等于缓冲区的深度值时通过测试 |
| GL_GREATER  | 在片段深度值大于缓冲区的深度值时通过测试     |
| GL_NOTEQUAL | 在片段深度值不等于缓冲区的深度值时通过测试   |
| GL_GEQUAL   | 在片段深度值大于等于缓冲区的深度值时通过测试 |

## 深度值计算公式

深度值并非直接套用物体的z坐标，而是一般是用一个非线形方程来计算最终深度。
$$
F_{depth} = \frac{1/z - 1/\text{near}}{1/\text{far} - 1/\text{near}}
$$
深度值很大一部分是由很小的z值所决定的，这给了近处的物体很大的深度精度。这个（从观察者的视角）变换z值的方程是嵌入在投影矩阵中的，所以当我们想将一个顶点坐标从观察空间至裁剪空间的时候这个非线性方程就被应用了。

## 深度冲突

一个很常见的视觉错误会在两个平面或者三角形非常紧密地平行排列在一起时会发生，深度缓冲没有足够的精度来决定两个形状哪个在前面。结果就是这两个形状不断地在切换前后顺序，这会导致很奇怪的花纹。这个现象叫做深度冲突(Z-fighting)，因为它看起来像是这两个形状在争夺(Fight)谁该处于顶端。

### 常见解决办法

1. **永远不要把多个物体摆得太靠近，以至于它们的一些三角形会重叠**。通过在两个物体之间设置一个用户无法注意到的偏移值，你可以完全避免这两个物体之间的深度冲突。但是这需要对每个物体都手动调整，并且需要进行彻底的测试来保证场景中没有物体会产生深度冲突。

2. **尽可能将近平面设置远一些**。默认情况下，深度值的精度在靠近**近**平面时是非常高的，所以将**近**平面远离观察者，将会对整个平截头体有着更大的精度。但是将近平面设置太远将会导致近处的物体被裁剪掉，这通常需要实验和微调来决定最适合你的场景的**近**平面距离。

3. **使用更高精度的深度缓冲**。大部分深度缓冲的精度都是24位的，但现在大部分的显卡都支持32位的深度缓冲，这将会极大地提高精度。所以，牺牲掉一些性能，你就能获得更高精度的深度测试，减少深度冲突。