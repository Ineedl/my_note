[toc]

## GO_GC

老版本GO的GC使用使用STW。

**STW**：stop the word，指程序执行过程中，中断暂停程序逻辑，专门去进行[垃圾回收]

GO的一次STW执行逻辑如下。

- 开启STW，
- 从根节点出发，标记所有可达对象
- 停止STW，然后回收所有未标记的对象。

### 缺点

串形化，GC清除会中断程序运行。

## 标记清除法

GO的每一个堆上变量都被GC进行了标记，GO把根数据段上的每个数据作为root，基于他们进行进一步的追踪，追踪到的数据就进行标记，最后把没有标记的对象当作垃圾进行释放。

* 优化了原先的方式，不再串形化执行。

### 三色标记法

GO1.5版本引入三色标记法，GC在执行时会将栈上变量标记为以下三种颜色

* 黑色：表示有用的对象，并且已经分析扫描完，不可删除
* 灰色：未分析扫描，不知道是否可删除。
* 白色：无用的节点，仍然可以分析，可删除。

### 标记清除法详细步骤

第一，首先一开始所有的对象都是白色的，从根节点出发，将根节点可达的对象置为灰色。
第二，然后分析灰色节点指向的节点，将灰色节点指向的节点(可能又有新的节点)置为灰色节点，分析完一个灰色节点的所有指向后将该灰色节点置为黑色，表示该节点有用，并且已经扫描完。
第三，重复步骤二，直到没有节点的颜色发生变化，剩下的白色节点就是无用的节点。
第四，在二的步骤中，如果有变量发生了插入或删除或修改操作，此时将把该对象置为灰色。(混合屏障，该特性在Go 1.9中引入)

* 注：在GC回收的开始标记阶段会暂停阻塞的go程序业务，对初始gc节点进行标记，在这之后，不会再阻塞业务。

## GC触发时机

Go 源码的 `src/runtime/mgc.go` 文件，明确标识了 GC 系统触发的三种场景

- gcTriggerHeap：当所分配的堆大小达到阈值（由控制器计算的触发堆的大小）时，将会触发。
- gcTriggerTime：当距离上一个 GC 周期的时间超过一定时间时，将会触发。-时间周期以 `runtime.forcegcperiod` 变量为准，默认 2 分钟。
- gcTriggerCycle：如果没有开启 GC，则启动 GC。(手动触发)
  - 在手动触发的 `runtime.GC` 方法中涉及。