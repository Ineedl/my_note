[toc]

## 所在明明空间和常用类型

* 命名空间：System.Reflection 

| 类              | 作用                                                         |
| --------------- | ------------------------------------------------------------ |
| Assembly        | 定义和加载程序集，加载在程序集清单中列出模块，以及从此程序集中查找类型并创建该类型的实例。 |
| MethodInfo      | 了解方法的名称、返回类型、参数、访问修饰符（如pulic 或private）和实现详细信息（如abstract或virtual）等。使用Type的GetMethods或GetMethod方法来调用特定的方法。 |
| PropertyInfo    | 了解属性的名称、数据类型、声明类型、反射类型和只读或可写状态等，获取或设置属性值。 |
| FieldInfo       | 了解字段的名称、访问修饰符（如public或private）和实现详细信息（如static）等，并获取或设置字段值。 |
| MemberInfo      | 用于获取有关类 (构造函数、事件、字段、方法和属性) 的所有成员的信息。此类引入所有成员提供的基本功能。 |
| EventInfo       | 了解事件的名称、事件处理程序数据类型、自定义属性、声明类型和反射类型等，添加或移除事件处理程序。 |
| ConstructorInfo | 了解构造函数的名称、参数、访问修饰符（如pulic 或private）和实现详细信息（如abstract或virtual）等。使用Type的GetConstructors或 GetConstructor方法来调用特定的构造函数。 |
| ParameterInfo   | 了解参数的名称、数据类型、是输入参数还是输出参数，以及参数在方法签名中的位置等。 |

## System.Type类

通过这个类可以访问任何给定数据类型的信息。 System.Type 类对于反射起着核心的作用。但它是一个抽象的基类，Type有与每种数据类型对应的派生类，我们使用这个派生类的对象的方法、字段、属性来查找有关该类型的所有信息。

### 获取Type对象

```c#
Type t = typeof(int);

int i;
Type t = i.GetType();

Type t = Type.GetType("System.Double");
```

### 常用属性

| 属性        | 描述                                 |
| ----------- | ------------------------------------ |
| Name        | 数据类型名                           |
| FullName    | 数据类型的完全限定名(包括命名空间名) |
| Namespace   | 定义数据类型的命名空间名             |
| IsAbstract  | 指示该类型是否是抽象类型             |
| IsArray     | 指示该类型是否是数组                 |
| IsClass     | 指示该类型是否是类                   |
| IsEnum      | 指示该类型是否是枚举                 |
| IsInterface | 指示该类型是否是接口                 |
| IsPublic    | 指示该类型是否是公有的               |
| IsSealed    | 指示该类型是否是密封类               |
| IsValueType | 指示该类型是否是值类型               |

### 常用方法

| 方法                               | 描述                                                    |
| ---------------------------------- | ------------------------------------------------------- |
| GetConstructor(),GetConstructors() | 返回ConstructorInfo类型，用于取得该类的构造函数的信息   |
| GetEvent(), GetEvents()            | 返回EventInfo类型，用于取得该类的事件的信息             |
| GetField(), GetFields()            | 返回FieldInfo类型，用于取得该类的字段（成员变量）的信息 |
| GetInterface(),GetInterfaces()     | 返回InterfaceInfo类型，用于取得该类实现的接口的信息     |
| GetMember(), GetMembers()          | 返回MemberInfo类型，用于取得该类的所有成员的信息        |
| GetMethod(), GetMethods()          | 返回MethodInfo类型，用于取得该类的方法的信息            |
| GetProperty(), GetProperties()     | 返回PropertyInfo类型，用于取得该类的属性的信息          |

## BindingFlags 指定反射查找范围

BindingFlags参数在各种反射函数中都有调用

| 值               | 范围                                                         |
| ---------------- | ------------------------------------------------------------ |
| default          | BindingFlags.Public \| BindingFlags.Instance                 |
| IgnoreCase       | 忽略大小写                                                   |
| DeclaredOnly     | 仅查找此特定类型中声明的成员，而不会包括这个类继承得到的成员 |
| Instance         | 仅查找类型中的实例成员                                       |
| Static           | 仅查找类型中的静态成员                                       |
| Public           | 仅查找类型中的公共成员                                       |
| NonPublic        | 仅查找类型中的非公共成员（internal protected private）       |
| FlattenHierarchy | 会查找此特定类型继承树上得到的静态成员。但仅继承公共（public）静态成员和受保护（protected）静态成员；不包含私有静态成员，也不包含嵌套类型。 |

### 常用组合

* 获取所有成员：BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Static | BindingFlags.Instance
* 拿到公有的实例成员：BindingFlags.Public | BindingFlags.Instance

### 常见出现的使用方法

```
// 调用方法。
InvokeMethod

// 创建实例。
CreateInstance

// 获取字段的值。
GetField

// 设置字段的值。
SetField

// 获取属性的值。
GetProperty

// 设置属性的值。
SetProperty
```



## System.Reflection.Assembly 类

该类可以用来动态加载程序库并生成对应的类对象

### 常用方法

| 方法             | 描述                                               |
| ---------------- | -------------------------------------------------- |
| Load(String)     | 通过程序集名称返回Assembly对象                     |
| LoadFrom(String) | 通过DLL文件名称返回Assembly对象                    |
| LoadFile(String) | 加载指定路径上的程序集文件的内容返回Assembly对象。 |
| GetType(String)  | 通过Assembly获取程序集中类，参数必须是类的全名     |
| GetTypes         | 通过Assembly获取程序集中所有的类                   |

`例`

```c#
// 通过程序集名称返回Assembly对象
Assembly ass = Assembly.Load("MyClassLibrary");
// 通过DLL文件名称返回Assembly对象
Assembly ass = Assembly.LoadFrom("MyClassLibrary.dll");
// 通过Assembly获取程序集中类
Type t = ass.GetType("MyClassLibrary.NewClass");   //参数必须是类的全名
 // 通过Assembly获取程序集中所有的类
Type[] t = ass.GetTypes();
```

## 使用反射生成类对象

### 用构造函数动态生成对象

```
Type peopleType = people.GetType();
// 根据参数类型获取构造函数 
ConstructorInfo constructor1 = peopleType.GetConstructor(new Type[]{ typeof(string), typeof(int) });
// 构造Object数组，作为构造函数的输入参数 
object[] obj = new object[2]{ "ming111", 22 };   
// 调用构造函数生成对象 
object o = constructor1.Invoke(obj);  
// 调用生成的对象的方法测试是否对象生成成功 
((People)o).SayHello();  
```

### 用Activator生成对象

```
Type peopleType = people.GetType();
object obj1 = Activator.CreateInstance(peopleType, "ming222", 25);
((People)obj1).SayHello();  
```

## 综合案例

### 属性的获取以及修改

* 反射可以访问即使是私有的（`private`）和受保护的（`protected`）成员

```
BindingFlags flag = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Static | BindingFlags.Instance;

People people = new People("ming", 18);
// 获取Type对象
Type peopleType = people.GetType();
// 获取name字段值
Console.WriteLine("------获取name字段值------");
FieldInfo nameField = peopleType.GetField("name", flag);
Console.WriteLine(nameField.GetValue(people));
// 设置name字段
Console.WriteLine("------设置name字段------");
nameField.SetValue(people, "ming123");
Console.WriteLine(nameField.GetValue(people));
// 获取所有字段
Console.WriteLine("------获取所有字段------");
FieldInfo[] fieldInfos = peopleType.GetFields(flag);
foreach (var field in fieldInfos)
{
    Console.WriteLine($"{field.Name}: {field.GetValue(people)}");
}
// 获取所有属性
Console.WriteLine("------获取所有属性------");
PropertyInfo[] propertyInfos = peopleType.GetProperties(flag);
foreach (var property in propertyInfos)
{
    Console.WriteLine($"{property.Name}: {property.GetValue(people)}");
}
// 获取所有方法
Console.WriteLine("------获取所有方法------");
MethodInfo[] methodInfos = peopleType.GetMethods(BindingFlags.Instance | BindingFlags.Public);
foreach (var method in methodInfos)
{
    Console.WriteLine($"{method.Name}");
}
// 查看类构造函数
ConstructorInfo[] constructorInfos = peopleType.GetConstructors();    
foreach (ConstructorInfo constructor in constructorInfos)
{
    ParameterInfo[] ps = constructor.GetParameters();   //取出每个构造函数的所有参数
    foreach (ParameterInfo pi in ps)                    
    {
        Console.Write(pi.ParameterType.ToString() + " " + pi.Name + ",");
    }
}

/*
------获取name字段值------
ming
------设置name字段------
ming123
------获取所有字段------
name: ming123
age: 18
------获取所有属性------
Name: ming123
Age: 18
------获取所有方法------
get_Name
set_Name
get_Age
set_Age
SayHello
GetType
ToString
Equals
GetHashCode
------查看类构造函数------
System.String name,System.Int32 age,
*/
————————————————
```

### 方法以及重载方法的调用

```
Type peopleType = people.GetType();

// 调用无参方法
MethodInfo method1 = peopleType.GetMethod("SayHello");
Console.WriteLine($"方法名:{method1.Name}");
Console.WriteLine($"返回值:{method1.ReturnType}");
method1.Invoke(people, null);
/*
方法名:SayHello
返回值:System.Void
ming123 say: Hello
*/
————————————————


// 指定要调用的重载方法的参数类型
Type[] paramTypes1 = { typeof(int), typeof(int) };
Type[] paramTypes2 = { typeof(double), typeof(double) };

MethodInfo method7 = peopleType.GetMethod("Add", paramTypes1);
MethodInfo method8 = peopleType.GetMethod("Add", paramTypes2);

// 调用重载方法
var result1 = method7.Invoke(people, new object[] { 10, 20 });
var result2 = method8.Invoke(people, new object[] { 5.5, 6.5 });

Console.WriteLine($"10 + 20 = {result1}");
Console.WriteLine($"5.5 + 6.5 = {result2}");
```

